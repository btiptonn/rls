<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Residential Laundry System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
    }
    .container {
      max-width: 600px;
      width: 100%;
      padding: 24px;
    }
    h1 {
      margin-top: 0;
      margin-bottom: 8px;
    }
    .card {
      background: #111827;
      border-radius: 16px;
      padding: 16px 20px;
      margin-bottom: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    }
    .label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .value {
      font-size: 24px;
      font-weight: 600;
    }
    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 8px;
    }
    input, select, button {
      font: inherit;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      padding: 8px 12px;
      outline: none;
    }
    input:focus, select:focus {
      border-color: #38bdf8;
    }
    button {
      cursor: pointer;
      border: none;
      background: #38bdf8;
      color: #020617;
      font-weight: 600;
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.1s ease;
    }
    button:hover {
      background: #0ea5e9;
      box-shadow: 0 8px 20px rgba(56, 189, 248, 0.4);
      transform: translateY(-1px);
    }
    button:active {
      transform: translateY(0);
      box-shadow: none;
    }
    .button-secondary {
      background: #4b5563;
      color: #e5e7eb;
    }
    .button-secondary:hover {
      background: #6b7280;
      box-shadow: 0 8px 20px rgba(107, 114, 128, 0.4);
    }
    .pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: #111827;
      color: #9ca3af;
    }
    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .pill-idle  .pill-dot { background: #9ca3af; }
    .pill-running .pill-dot { background: #22c55e; }
    .pill-finished .pill-dot { background: #facc15; }
    .pill-error .pill-dot { background: #f97316; }
    .log {
      max-height: 200px;
      overflow-y: auto;
      font-size: 12px;
    }
    .log-entry {
      padding: 4px 0;
      border-bottom: 1px solid #111827;
      color: #9ca3af;
    }
    .log-entry strong {
      color: #e5e7eb;
    }
    .small {
      font-size: 12px;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Residential Laundry System</h1>
    <div class="small">Pico W + RFID + Vibration · Live status from backend</div>

    <!-- STATUS CARD -->
    <div class="card">
      <div class="label">Machine State</div>
      <div class="row" style="justify-content: space-between; align-items: center;">
        <div id="state-pill" class="pill pill-idle">
          <div class="pill-dot"></div>
          <span id="state-text">Idle</span>
        </div>
        <div style="text-align: right;">
          <div class="label">Remaining</div>
          <div class="value" id="timer-text">00:00:00</div>
        </div>
      </div>

      <div class="row">
        <div>
          <div class="label">RFID User</div>
          <div class="value" id="rfid-text">—</div>
        </div>
        <div>
          <div class="label">Expected (min)</div>
          <div class="value" id="expected-text">0</div>
        </div>
      </div>
      <div class="small" id="last-update-text" style="margin-top: 6px;">Last update: —</div>
    </div>

    <!-- CONTROLS CARD -->
    <div class="card">
      <div class="label">Manual Controls</div>
      <div class="row">
        <select id="expected-input">
          <option value="30">30 min</option>
          <option value="45" selected>45 min</option>
          <option value="60">60 min</option>
          <option value="75">75 min</option>
          <option value="90">90 min</option>
        </select>

        <button id="start-btn">Start</button>
        <button id="stop-btn" class="button-secondary">Stop</button>
      </div>
      <div class="small" style="margin-top: 8px;">
        Start sets the official timer on the server. Pico just sends heartbeats; timer is never reset by heartbeat.
      </div>
    </div>

    <!-- LOG CARD -->
    <div class="card">
      <div class="label">Recent Events</div>
      <div class="log" id="log-container"></div>
    </div>
  </div>

  <script>
    const statePill = document.getElementById("state-pill");
    const stateText = document.getElementById("state-text");
    const timerText = document.getElementById("timer-text");
    const rfidText = document.getElementById("rfid-text");
    const expectedText = document.getElementById("expected-text");
    const lastUpdateText = document.getElementById("last-update-text");
    const logContainer = document.getElementById("log-container");

    const expectedInput = document.getElementById("expected-input");
    const startBtn = document.getElementById("start-btn");
    const stopBtn = document.getElementById("stop-btn");

    function setStatePill(state) {
      state = state || "Idle";
      statePill.className = "pill";

      switch (state) {
        case "Running":
          statePill.classList.add("pill-running");
          break;
        case "Finished":
          statePill.classList.add("pill-finished");
          break;
        case "Error":
          statePill.classList.add("pill-error");
          break;
        default:
          statePill.classList.add("pill-idle");
      }

      stateText.textContent = state;
    }

    function formatSeconds(total) {
      total = Math.max(0, Math.floor(total));
      const h = Math.floor(total / 3600);
      const m = Math.floor((total % 3600) / 60);
      const s = total % 60;
      return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
    }

    async function fetchStatus() {
      try {
        const res = await fetch("/api/status");
        const data = await res.json();

        setStatePill(data.state);
        expectedText.textContent = data.expected ?? 0;
        rfidText.textContent = data.rfid || "—";

        // prefer remaining_s; fallback to remaining_str
        if (typeof data.remaining_s === "number") {
          timerText.textContent = formatSeconds(data.remaining_s);
        } else if (data.remaining_str) {
          timerText.textContent = data.remaining_str;
        } else {
          timerText.textContent = "00:00:00";
        }

        if (data.last_update) {
          lastUpdateText.textContent = "Last update: " + data.last_update;
        }

        if (Array.isArray(data.log)) {
          logContainer.innerHTML = "";
          data.log.forEach(entry => {
            const div = document.createElement("div");
            div.className = "log-entry";
            div.innerHTML = `<strong>[${entry.event}]</strong> ${entry.ts} – ${entry.info || ""}`;
            logContainer.appendChild(div);
          });
        }

      } catch (e) {
        console.error("Status error", e);
        setStatePill("Error");
        timerText.textContent = "—";
        lastUpdateText.textContent = "Last update: error";
      }
    }

    async function startCycle() {
      const expected = parseInt(expectedInput.value, 10) || 45;
      startBtn.disabled = true;
      try {
        const res = await fetch("/api/start", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            expected: expected,
            rfid: null,      // if you want, you can wire this from a scanned user later
            lock_uid: null
          })
        });
        const data = await res.json();
        console.log("start response", data);
      } catch (e) {
        console.error("start error", e);
      } finally {
        startBtn.disabled = false;
      }
    }

    async function stopCycle() {
      stopBtn.disabled = true;
      try {
        const res = await fetch("/api/stop", {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });
        const data = await res.json();
        console.log("stop response", data);
      } catch (e) {
        console.error("stop error", e);
      } finally {
        stopBtn.disabled = false;
      }
    }

    startBtn.addEventListener("click", startCycle);
    stopBtn.addEventListener("click", stopCycle);

    // Poll every second
    setInterval(fetchStatus, 1000);
    fetchStatus();
  </script>
</body>
</html>
