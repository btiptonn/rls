<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Washer â€” Machine 1</title>

  <style>
    :root {
      --accent: #2a6fb5;
      --bg: #eef3fa;
      --card-bg: rgba(255,255,255,0.9);
    }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      background-image: linear-gradient(180deg, #f2f6fc 0%, #dbe7f8 100%);
      margin: 0;
      color: #1a1a1a;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background: var(--accent);
      color: #fff;
      padding: 1.2rem;
      text-align: center;
      font-size: 1.5rem;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1.5rem;
    }

    .card {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 14px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      padding: 2rem;
      width: 360px;
      text-align: center;
      margin-top: 1rem;
    }

    .led {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      margin: 1rem auto;
      border: 3px solid #333;
    }

    .green { background: #3ad33a; }
    .red   { background: #e24b4b; }
    .blue  { background: #408ef5; }
    .yellow{ background: #f5d547; }
    .gray  { background: #c5c5c5; }

    .log {
      margin-top: 2rem;
      width: 360px;
      background: var(--card-bg);
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    footer {
      text-align: center;
      font-size: 0.8rem;
      color: #666;
      padding: 0.6rem;
    }
  </style>
</head>

<body>
  <header>ðŸ§º Washer â€” Machine 1</header>

  <main>
    <button onclick="window.location.href='index.html'">â¬… Back to Home</button>

    <div class="card">
      <h3 id="stateText">Idle</h3>
      <div id="led" class="led gray"></div>
      <p><strong>RFID:</strong> <span id="rfidText">â€”</span></p>
      <p><strong>Cycle timer:</strong> <span id="timerText">00:00</span></p>
      <p><strong>Expected length:</strong> <span id="expectedText">0</span> min</p>
    </div>

    <div class="log">
      <h3>Event log</h3>
      <div id="log"></div>
    </div>
  </main>

  <footer>Â© 2025 RLS | Live updates every 3s</footer>

<script>
const API = "https://rls-uvzg.onrender.com/api/state";

let last = { state:"", rfid:"" };
let countdown = 0, active = false;

function parse(t){
  if(!t.includes(":")) return null;
  let [m,s] = t.split(":").map(Number);
  return m*60 + s;
}

async function fetchState(){
  try{
    let res = await fetch(API,{cache:"no-store"});
    let d  = await res.json();

    document.getElementById("rfidText").textContent = d.rfid;
    document.getElementById("stateText").textContent = d.state;
    document.getElementById("expectedText").textContent = d.expected;

    let led = document.getElementById("led");
    led.className = "led " + (
      d.state === "Running" ? "green" :
      d.state === "Complete"? "blue"  :
      d.state === "Aborted" ? "red"   :
      d.state === "Booted"  ? "yellow": "gray"
    );

    let serverSeconds = parse(d.time);

    if(d.state === "Running"){
      if(!active || last.state !== "Running"){
        countdown = serverSeconds;
        active = true;
        addLog(`Cycle started (${d.time})`);
      }
    } else {
      active = false;
      if(d.state === "Complete") addLog("Cycle complete!");
      if(d.state === "Aborted")  addLog("Cycle aborted.");
      countdown = 0;
      document.getElementById("timerText").textContent = "00:00";
    }

    if(last.state !== d.state || last.rfid !== d.rfid){
      addLog(`State â†’ ${d.state}, RFID â†’ ${d.rfid}`);
      last = d;
    }

  } catch(e){
    console.error("ERR:",e);
  }
}

function tick(){
  if(active && countdown > 0) countdown--;
  let m = String(Math.floor(countdown/60)).padStart(2,"0");
  let s = String(countdown%60).padStart(2,"0");
  document.getElementById("timerText").textContent = `${m}:${s}`;
}

function addLog(msg){
  let log = document.getElementById("log");
  let e = document.createElement("div");
  e.textContent = `${msg} â€” ${new Date().toLocaleTimeString()}`;
  log.prepend(e);
}

setInterval(fetchState,3000);
setInterval(tick,1000);
fetchState();
</script>

</body>
</html>
