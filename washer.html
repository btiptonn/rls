<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Washer — Machine 1</title>

  <style>
    :root {
      --accent: #2a6fb5;
      --card-bg: rgba(255,255,255,0.88);
      --text: #111;
      --danger: #e24b4b;
      --success: #30b82e;
      --complete: #408ef5;
      --locked: #cc8500;
      --idle: #7c8ca1;
    }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #eef3fa;
      margin: 0;
    }

    header {
      background: var(--accent);
      color: #fff;
      padding: 1rem;
      text-align: center;
      font-size: 1.4rem;
      position: relative;
    }

    a.back {
      position: absolute;
      top: 15px;
      left: 15px;
      color: #fff;
      text-decoration: none;
      font-size: 1rem;
    }

    .container {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      max-width: 650px;
      margin: auto;
    }

    .card {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .status-big {
      font-size: 1.5rem;
      margin-bottom: 0.7rem;
      font-weight: 600;
    }

    .state-running { color: var(--success); }
    .state-complete { color: var(--complete); }
    .state-aborted { color: var(--danger); }
    .state-locked  { color: var(--locked); }
    .state-idle    { color: var(--idle); }

    .info-row {
      margin: 6px 0;
      font-size: 1.1rem;
    }

    .timer-box {
      margin-top: 1rem;
      padding: 1rem;
      background: #f8fbff;
      border-radius: 10px;
      font-size: 1.3rem;
      font-weight: 600;
      text-align: center;
      border-left: 4px solid var(--accent);
    }

    #warningBox {
      padding: 1rem;
      border-radius: 10px;
      font-weight: 600;
      display: none;
      margin-top: 1rem;
    }

    #warningBox.locked {
      display: block;
      background: #ffe6bf;
      border-left: 6px solid var(--locked);
      color: #844f00;
    }

    #warningBox.aborted {
      display: block;
      background: #ffd3d3;
      border-left: 6px solid var(--danger);
      color: #880000;
    }

    #warningBox.complete {
      display: block;
      background: #dbe9ff;
      border-left: 6px solid var(--complete);
      color: #003a99;
    }

    /* Log List */
    #eventLog {
      list-style: none;
      padding-left: 0;
      margin-top: 1rem;
    }

    #eventLog li {
      padding: 0.4rem 0;
      border-bottom: 1px solid #ccc;
      font-size: 0.95rem;
    }
  </style>
</head>

<body>
  <header>
    <a class="back" href="index.html">← Back</a>
    Washer — Machine 1
  </header>

  <main class="container">

    <!-- MACHINE STATUS CARD -->
    <div class="card">
      <div id="machineStateText" class="status-big state-idle">Loading...</div>

      <div class="info-row"><strong>RFID:</strong> <span id="rfidStatus">None</span></div>
      <div class="info-row"><strong>Machine State:</strong> <span id="machineState">Idle</span></div>
      <div class="info-row"><strong>Expected:</strong> <span id="expected">0</span> min</div>

      <div id="warningBox"></div>

      <div class="timer-box">
        Time Remaining:<br>
        <span id="cycleTimer">00:00</span>
      </div>

      <div class="info-row">
        <strong>Lock Owner UID:</strong> <span id="lockUID">None</span>
      </div>
    </div>

    <!-- EVENT LOG -->
    <div class="card">
      <h3>Event Log</h3>
      <ul id="eventLog"></ul>
    </div>

  </main>

  <script>
    // IMPORTANT: this should be your Render backend URL
    const API_STATE_URL = "https://rls-uvzg.onrender.com/api/state";
    const API_LOG_URL   = "https://rls-uvzg.onrender.com/api/log";

    let remainingSeconds = null;
    let lastState = null;

    function parseTime(t) {
      const [m, s] = t.split(":");
      return (parseInt(m) * 60) + parseInt(s);
    }

    function formatTime(sec) {
      const m = Math.floor(sec / 60).toString().padStart(2, "0");
      const s = Math.floor(sec % 60).toString().padStart(2, "0");
      return `${m}:${s}`;
    }

    function setStateHeadline(state) {
      const el = document.getElementById("machineStateText");
      el.className = "status-big";

      let cls = "state-idle";
      let text = "Idle";

      switch (state) {
        case "Running":
          cls = "state-running"; text = "Running"; break;
        case "Complete":
          cls = "state-complete"; text = "Cycle Complete"; break;
        case "Aborted":
          cls = "state-aborted"; text = "Cycle Aborted"; break;
        case "Locked":
          cls = "state-locked"; text = "Machine Locked"; break;
        default:
          cls = "state-idle"; text = state || "Idle";
      }

      el.classList.add(cls);
      el.textContent = text;
    }

    function setWarningBox(state) {
      const wb = document.getElementById("warningBox");
      wb.className = "";
      wb.style.display = "none";
      wb.textContent = "";

      if (state === "Locked") {
        wb.classList.add("locked");
        wb.textContent = "Machine is locked for this user.";
      } else if (state === "Aborted") {
        wb.classList.add("aborted");
        wb.textContent = "Cycle was aborted. Please check the machine.";
      } else if (state === "Complete") {
        wb.classList.add("complete");
        wb.textContent = "Cycle complete! Please remove your laundry.";
      }
    }

    // ---- COUNTDOWN LOOP ----
    setInterval(() => {
      if (remainingSeconds !== null && lastState === "Running") {
        remainingSeconds--;
        if (remainingSeconds < 0) remainingSeconds = 0;
        document.getElementById("cycleTimer").textContent =
          formatTime(remainingSeconds);
      }
    }, 1000);

    // ---- SERVER POLL ----
    async function updateWasher() {
      try {
        const res = await fetch(API_STATE_URL, { cache: "no-store" });
        if (!res.ok) return;
        const data = await res.json();

        const state = data.state || "Idle";
        const time = data.time || "00:00";

        // Update other UI elements normally
        document.getElementById("machineState").textContent = state;
        document.getElementById("rfidStatus").textContent = data.rfid || "None";
        document.getElementById("expected").textContent = data.expected || 0;
        document.getElementById("lockUID").textContent = data.lock_uid || "None";

        setStateHeadline(state);
        setWarningBox(state);

        // ---- TIMER LOGIC ----
        const serverSec = parseTime(time);

        if (state !== lastState) {
          // State changed → trust the server completely
          remainingSeconds = serverSec;
          document.getElementById("cycleTimer").textContent = formatTime(serverSec);
        }

        // If difference > 3 seconds → drift correction
        if (remainingSeconds === null || Math.abs(serverSec - remainingSeconds) > 3) {
          remainingSeconds = serverSec;
        }

        lastState = state;

      } catch (err) {
        console.error("updateWasher error:", err);
      }
    }

    async function fetchLog() {
      try {
        const res = await fetch(API_LOG_URL, { cache: "no-store" });
        if (!res.ok) return;
        const log = await res.json();
        const ul = document.getElementById("eventLog");
        ul.innerHTML = "";

        log.forEach(entry => {
          const li = document.createElement("li");
          li.textContent = `[${entry.ts}] ${entry.event} (state: ${entry.state}, RFID: ${entry.rfid || "None"})`;
          ul.appendChild(li);
        });
      } catch (err) {
        console.error("fetchLog error:", err);
      }
    }

    // initial load + polling
    updateWasher();
    fetchLog();

    setInterval(() => {
      updateWasher();
      fetchLog();
    }, 2000); // 2s poll
  </script>
</body>
</html>
