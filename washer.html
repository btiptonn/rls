<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Washer â€” Machine 1</title>
  <style>
    :root {
      --accent: #2a6fb5;
      --bg: #eef3fa;
      --card-bg: rgba(255,255,255,0.9);
    }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      background-image: linear-gradient(180deg, #f2f6fc 0%, #dbe7f8 100%);
      margin: 0;
      color: #1a1a1a;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background: var(--accent);
      color: #fff;
      padding: 1.2rem;
      text-align: center;
      font-size: 1.5rem;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1.5rem;
    }

    .card {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 14px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      padding: 2rem;
      width: 360px;
      text-align: center;
      margin-top: 1rem;
    }

    .led {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      margin: 1rem auto;
      border: 3px solid #333;
    }

    .led.green { background: #3ad33a; }
    .led.red { background: #e24b4b; }
    .led.blue { background: #408ef5; }
    .led.yellow { background: #f5d547; }
    .led.gray { background: #c5c5c5; }

    .log {
      margin-top: 2rem;
      width: 360px;
      background: var(--card-bg);
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    button {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      background: var(--accent);
      color: white;
      cursor: pointer;
      font-weight: bold;
      margin-top: 1rem;
      transition: background 0.2s;
    }

    button:hover {
      background: #4a8de0;
    }

    footer {
      text-align: center;
      font-size: 0.8rem;
      color: #666;
      padding: 0.6rem;
    }
  </style>
</head>
<body>
  <header>ðŸ§º Washer â€” Machine 1</header>

  <main>
    <button onclick="window.location.href='index.html'">â¬… Back to Home</button>

    <div class="card">
      <h3 id="stateText">Idle</h3>
      <div id="led" class="led gray"></div>
      <p><strong>RFID:</strong> <span id="rfidText">â€”</span></p>
      <p><strong>Cycle timer:</strong> <span id="timerText">00:00</span></p>
      <p><strong>Expected length:</strong> <span id="expectedText">0</span> min</p>
    </div>

    <div class="log">
      <h3>Event log</h3>
      <div id="log"></div>
    </div>
  </main>

  <footer>Â© 2025 RLS | Live updates every 3s</footer>

  <script>
    const API_URL = "https://rls-uvzg.onrender.com/api/state";

    let lastState = "", lastRFID = "";
    let countdownSeconds = 0, countdownActive = false, initializedRun = false;

    function parseMMSS(t) {
      if (!t || typeof t !== "string" || !t.includes(":")) return null;
      const [m, s] = t.split(":").map(Number);
      return isNaN(m) || isNaN(s) ? null : m * 60 + s;
    }

    async function fetchState() {
      try {
        const res = await fetch(API_URL, { cache: "no-store" });
        const data = await res.json();
        const state = data.state || "Idle";
        const rfid = data.rfid || "â€”";
        const serverSeconds = parseMMSS(data.time);

        document.getElementById("rfidText").textContent = rfid;
        document.getElementById("stateText").textContent = state;
        document.getElementById("expectedText").textContent = data.expected || 0;

        const led = document.getElementById("led");
        led.className = "led " +
          (state === "Running" ? "green" :
           state === "Complete" ? "blue" :
           state === "Aborted" ? "red" :
           state === "Booted" ? "yellow" : "gray");

        if (state === "Running") {
          if (!initializedRun || lastState !== "Running") {
            if (serverSeconds !== null) countdownSeconds = serverSeconds;
            countdownActive = true;
            initializedRun = true;
            addLog(`Cycle started (${data.time})`);
          } else if (serverSeconds !== null && serverSeconds < countdownSeconds - 3) {
            countdownSeconds = serverSeconds;
          }
        } else {
          countdownActive = false;
          initializedRun = false;
          if (state === "Aborted" || state === "Complete") countdownSeconds = 0;
        }

        if (state === "Aborted") {
          countdownActive = false;
          countdownSeconds = 0;
          document.getElementById("timerText").textContent = "00:00";
          addLog("Cycle aborted due to inactivity.");
        }

        if (state !== lastState || rfid !== lastRFID) {
          addLog(`State â†’ ${state}, RFID: ${rfid}`);
          lastState = state;
          lastRFID = rfid;
        }
      } catch (err) {
        console.error("Fetch error:", err);
      }
    }

    function tickTimer() {
      if (countdownActive && countdownSeconds > 0) countdownSeconds--;
      const m = String(Math.floor(countdownSeconds / 60)).padStart(2, "0");
      const s = String(countdownSeconds % 60).padStart(2, "0");
      document.getElementById("timerText").textContent = `${m}:${s}`;
    }

    function addLog(msg) {
      const logDiv = document.getElementById("log");
      const t = new Date().toLocaleTimeString();
      const e = document.createElement("div");
      e.className = "logentry";
      e.textContent = `${msg} â€” ${t}`;
      logDiv.prepend(e);
    }

    setInterval(fetchState, 3000);
    setInterval(tickTimer, 1000);
    fetchState();
  </script>
</body>
</html>
