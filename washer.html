<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Washer ‚Äî Machine 1</title>

  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background: #f7f9fc; color: #222; }
    .site-header { background: #2b6cb0; color: white; padding: 1rem; display: flex; justify-content: space-between; }
    .back { color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 0.4rem 0.8rem; border-radius: 6px; }
    .container { padding: 1.5rem 2rem; }
    .status-box {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 1rem 1.5rem;
      margin-bottom: 1.5rem;
    }
    .rgb-led { width: 40px; height: 40px; border-radius: 50%; background: #999; display:inline-block; vertical-align:middle; }
    .rgb-led.green  { background:#27ae60; }
    .rgb-led.red    { background:#e74c3c; }
    .rgb-led.yellow { background:#f1c40f; }
    .log { background:#fff; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); padding:1rem 1.5rem; }
    #eventLog { list-style:none; padding:0; margin:0; }
    #eventLog li { border-bottom:1px solid #eee; padding:4px 0; font-size:0.9rem; }
    .disconnected { color:#999; font-style:italic; }
  </style>
</head>
<body>
  <header class="site-header">
    <h1>Washer ‚Äî Machine 1</h1>
    <a class="back" href="index.html">‚Üê Back</a>
  </header>

  <main class="container">
    <section class="status-box">
      <p><strong>RFID:</strong> <span id="rfid" class="disconnected">Waiting for connection‚Ä¶</span></p>
      <p><strong>State:</strong> <span id="state" class="disconnected">Idle</span></p>
      <p><strong>Time:</strong> <span id="time" class="disconnected">00:00</span></p>
      <div><strong>LED:</strong> <span id="led" class="rgb-led"></span></div>
    </section>

    <section class="log">
      <h3>Event log</h3>
      <ul id="eventLog"></ul>
    </section>
  </main>

  <script>
    // üîß Set to your PC‚Äôs local IP (the same one the Pico uses)
    const SERVER = "http://172.20.10.9:5501/api/state";

    let lastState = null;

    async function update() {
      try {
        const res = await fetch(SERVER, { cache: "no-store" });
        if (!res.ok) throw new Error("Bad response");
        const data = await res.json();

        // If the Pico hasn‚Äôt sent any real data yet, stop here.
        if (!data || data.rfid === "None") {
          showDisconnected("Waiting for Pico data‚Ä¶");
          return;
        }

        // Apply data
        document.getElementById("rfid").textContent  = data.rfid;
        document.getElementById("state").textContent = data.state;
        document.getElementById("time").textContent  = data.time;
        document.getElementById("rfid").classList.remove("disconnected");
        document.getElementById("state").classList.remove("disconnected");
        document.getElementById("time").classList.remove("disconnected");

        const led = document.getElementById("led");
        led.className = "rgb-led";
        if (data.state === "Running")  led.classList.add("green");
        else if (data.state === "Aborted") led.classList.add("red");
        else if (data.state === "Complete") led.classList.add("yellow");

        // Log changes only when state changes
        if (data.state !== lastState) {
          const li = document.createElement("li");
          li.textContent = new Date().toLocaleTimeString() + " ‚Äî State changed to " + data.state;
          document.getElementById("eventLog").prepend(li);
          lastState = data.state;
        }

      } catch (err) {
        showDisconnected("Server offline or unreachable");
      }
    }

    function showDisconnected(msg) {
      document.getElementById("rfid").textContent  = msg;
      document.getElementById("state").textContent = "Idle";
      document.getElementById("time").textContent  = "00:00";
      document.getElementById("rfid").classList.add("disconnected");
      document.getElementById("state").classList.add("disconnected");
      document.getElementById("time").classList.add("disconnected");
      const led = document.getElementById("led");
      led.className = "rgb-led";
    }

    setInterval(update, 2000);
    update();
  </script>
</body>
</html>
